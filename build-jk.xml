<project name="jSvnSubmitHook" default="all">

	<property file="build.properties" />
	
	<path id="includes">
		<!-- Lib -->
		<fileset dir="libs">
			<include name="**/*.jar"/>
		</fileset>
	</path>
	
	<target name="init">
		<delete dir="${gen}"/>
		<delete dir="testdata/filenameTest/filesNone"/>
		
		<mkdir dir="${gen}"/>
		<mkdir dir="${bin}"/>
		<mkdir dir="${test.dir}"/>
		<mkdir dir="${test.out}"/>
		<mkdir dir="${jar}"/>
		<mkdir dir="${jSvnCommit.dest}"/>
		<mkdir dir="${jSvnNotifier.dest}"/>
		<mkdir dir="${testSuite.dest}"/>
		<mkdir dir="testdata/filenameTest/filesNone">
	</target>
	
	<target name="compile" depends="init" description="compiles the class files">
	   <javac encoding="UTF-8" srcdir="${src}" compiler="modern" classpath="${classpath}" destdir="${bin}" debug="true">
	        <classpath refid="includes"/>
	   	</javac>
	</target>
	
	<target name="compile.tests" description="compiles the class files for testing">
        <javac srcdir="${src}" encoding="UTF-8" compiler="modern" destdir="${test.dir}" debug="on">
        	<src path="${src.tests}"/>
            <classpath refid="includes"/>
        </javac>
    </target>

	<target name="jar" depends="compile" description="creates the binary archive for the jSvnSubmitHook server">
		<delete file="${jSvnCommit.dest}/jSvnCommit-bin.jar"/>
	    <jar jarfile="${jSvnCommit.dest}/jSvnCommit-bin.jar"
	         basedir="${bin}"
	         excludes="jSvnCommit-bin.jar **/*.html hook/** *.jar de/uni_hildesheim/sse/javaSvnNotifier/**">
		  <!--fileset dir="..\ExerciseLib\bin" includes="**/*.class"/--> 
	    	<manifest>
                <attribute name="Main-Class" value="de.uni_hildesheim.sse.javaSvnCommit.Hook"/>
                <attribute name="Class-Path" value="${classpath.manifest}"/>
            </manifest>
	    </jar>
        <delete file="${jSvnCommit.dest}/Hook.jar"/>
        <jar jarfile="${jSvnCommit.dest}/Hook.jar"
                     basedir="${bin}">
        </jar>
        <delete file="${jSvnCommit.dest}/tmp.jar"/>
        <jar jarfile="${jSvnCommit.dest}/tmp.jar"
             basedir="${bin}"
             duplicate="preserve"
             excludes="jSvnPreCommitHook.jar **/*.html hook/** *.jar de/uni_hildesheim/sse/javaSvnNotifier/**">
            <zipgroupfileset dir="libs" includes="**/*.jar"/>
        </jar>
        <delete file="${jSvnCommit.dest}/jSvnPreCommitHook.jar"/>
        <jar destfile="${jSvnCommit.dest}/jSvnPreCommitHook.jar">
            <zipfileset src="${jSvnCommit.dest}/tmp.jar" excludes="META-INF/*.SF,META-INF/*.DSA,META-INF/*.RSA"/>
            <manifest>
                <attribute name="Main-Class" value="de.uni_hildesheim.sse.javaSvnHooks.pre_commit.PreCommitHook"/>
            </manifest>
        </jar>
        <delete file="${jSvnCommit.dest}/tmp.jar"/>
        <jar jarfile="${jSvnCommit.dest}/tmp.jar"
             basedir="${bin}"
             duplicate="preserve"
             excludes="jSvnPostCommitHook.jar.jar **/*.html hook/** *.jar de/uni_hildesheim/sse/javaSvnNotifier/**">
            <zipgroupfileset dir="libs" includes="**/*.jar"/>
        </jar>
        <delete file="${jSvnCommit.dest}/jSvnPostCommitHook.jar"/>
        <jar destfile="${jSvnCommit.dest}/jSvnPostCommitHook.jar">
            <zipfileset src="${jSvnCommit.dest}/tmp.jar" excludes="META-INF/*.SF,META-INF/*.DSA,META-INF/*.RSA"/>
            <manifest>
                <attribute name="Main-Class" value="de.uni_hildesheim.sse.javaSvnHooks.post_commit.PostCommitHook"/>
            </manifest>
        </jar>
        <delete file="${jSvnCommit.dest}/tmp.jar"/>
		<delete file="${jSvnNotifier.dest}/jSvnNotifier-bin.jar"/>
	    <jar jarfile="${jSvnNotifier.dest}/jSvnNotifier-bin.jar"
	         basedir="${bin}"
	         excludes="jSvnNotifier-bin.jar **/*.html hook/** *.jar de/uni_hildesheim/sse/javaSvnCommit/tests/** de/uni_hildesheim/sse/javaSvnCommit/Hook*.class de/uni_hildesheim/sse/javaSvnCommit/TxCleanup*.class">
		  <!-- fileset dir="..\ExerciseLib\bin" includes="**/*.class"/ -->
	    </jar>
       <mkdir dir="${docs}"/>
        <mkdir dir="${docs}/TestSuiteInterface"/>
        <javadoc doctitle="SvnSubmitHook - TestSuiteInterface" destdir="${docs}/TestSuiteInterface">
            <fileset dir="src/de/uni_hildesheim/sse/javaSvnHooks/tests/junit/testSuiteInterface"/>
            <fileset dir="src/de/uni_hildesheim/sse/test"/>
            <classpath refid="includes"/>
            <classpath path="${bin}"/>
        </javadoc>
        <zip file="${jar}/TestSuiteInterface-javadoc.zip" basedir="${docs}/TestSuiteInterface"/>
	</target>
	
	<target name="create.bundle" depends="jar">
		<!-- jSvnCommit -->
		<mkdir dir="${jSvnCommit.dest}/tests"/>
		<mkdir dir="${jSvnCommit.dest}/lib"/>
		<copy todir="${jSvnCommit.dest}/lib">
            <fileset dir="${lib}"/>
        </copy>
		<copy todir="${jSvnCommit.dest}">
		    <fileset dir="scripts"/>
		</copy>
		
		<!-- jSvnNotifier -->
		<mkdir dir="${jSvnNotifier.dest}/lib"/>
		<copy todir="${jSvnNotifier.dest}">
		    <fileset dir="scripts"/>
		</copy>
		<copy todir="${jSvnNotifier.dest}/lib">
		    <fileset dir="${lib}">
		    	<include name="**/*.jar"/>
		    	<exclude name="junit/**"/>
		    </fileset>
		</copy>
	</target>
	
	<target name="zip" depends="create.bundle">
		<zip destfile="${jar}/jSvnCommit-bin.zip" basedir="${jSvnCommit.dest}" excludes="jSvn*CommitHook.jar"/>
		<zip destfile="${jar}/jSvnNotifier-bin.zip" basedir="${jSvnNotifier.dest}" excludes="jSvn*CommitHook.jar"/>
	</target>
	
	<target name="test" depends="compile.tests">	
		<junit fork="false" forkmode="once">
			<test name="de.uni_hildesheim.sse.javaSvnHooks.unitTests.AllTests" outfile="${test.out}"/>
			<formatter type="xml"/>
			<classpath>
				<pathelement path="${test.dir}"/>
				<path refid="includes"/>
			</classpath>
		</junit>
	</target>
	<target name="test.interface">
		<jar jarfile="${testSuite.dest}/TestSuiteInterface.jar"
		             basedir="${bin}"
		             includes="de/uni_hildesheim/sse/javaSvnHooks/tests/junit/testSuiteInterface/** de/uni_hildesheim/sse/test/**">
			   
		        </jar>
	</target>
	<target name="all">
		<antcall target="zip"/>
	    <antcall target="test"/>
	    <antcall target="test.interface"/>
		
	</target>
	
</project>